name: CI Pipeline - Diff Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    types: [opened, synchronize]

jobs:
  diff-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        run: |
          # Define a base para comparaÃ§Ã£o (PR ou commit anterior)
          TARGET_BRANCH="${{ github.base_ref }}"
          if [ -z "$TARGET_BRANCH" ]; then
            BASE="HEAD~1"
          else
            git fetch origin $TARGET_BRANCH --depth=1
            BASE="origin/$TARGET_BRANCH"
          fi
          git diff $BASE > diff.txt

      - name: Analyze diff via n8n
        run: |
          # Verifica se hÃ¡ conteÃºdo no diff.txt
          if [ ! -s diff.txt ]; then
            echo '{"risk": "LOW", "reason": "No changes to analyze", "suggestions": ""}' > result.json
            echo "No changes detected, skipping analysis"
            exit 0
          fi

          echo "Sending diff to n8n for AI analysis..."
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: text/plain" \
            --data-binary @diff.txt \
            "${{ secrets.N8N_WEBHOOK_URL }}")

          echo "$RESPONSE" > result.json
          echo "Analysis result:"
          cat result.json | python3 -m json.tool 2>/dev/null || cat result.json

      - name: Fail if HIGH risk
        run: |
          RISK=$(python3 -c "import json; print(json.load(open('result.json')).get('risk','UNKNOWN'))" 2>/dev/null || echo "UNKNOWN")
          echo "Risk level: $RISK"

          if [ "$RISK" = "HIGH" ]; then
            echo "::error::ðŸš¨ HIGH risk breaking change detected!"
            python3 -c "import json; d=json.load(open('result.json')); print(f'Reason: {d.get(\"reason\",\"N/A\")}'); print(f'Suggestions: {d.get(\"suggestions\",\"N/A\")}')" 2>/dev/null
            exit 1
          fi

          echo "âœ… Risk level acceptable: $RISK"